{% extends 'base.html' %}

{% load static %}

{% block extrahead %}
<script src="{% static "js/d3.v3.min.js" %}"></script>
<script src="{% static "js/jsnetworkx.js" %}"></script>
{% endblock %}

{% block content %}
{% if type == "peers" %}
<h3>Peer overview</h3>
<p>This graph shows which router interconnections have been defined</p>
{% else %}
<h3>Status overview</h3>
<p>This graph shows the status of the routers. The colour indicates how long ago the router was last seen</p>
{% endif %}

<div id="canvas" style="width: 100%; height: 600px;background: #dfdfdf;"></div>

<script>
var G = new jsnx.MultiDiGraph();
G.addNodesFrom([
{% for router in routers %}
    [{{ router.id }}, {dns: '{{ router.dns }}', timeAgo: {{ router.timeAgo }}, owner: '{{ router.owner }}'}],{% endfor %}
], {color: '#1a6ecc' });

{% for router in routers %}{% for peer in router.all_peers %}{% if peer.dns %}G.addEdge({{ router.id }}, {{ peer.id }}, {dns: '{{ peer.dns }}', ip:'{{ peer.myip}}',remip:'{{ peer.remip }}'});
{% else %}G.addEdge({{ router.id }}, {{ peer.id }});
{% endif %}{% endfor %}{% endfor %}

var graphType = '{{ type }}';
var colours = ['limegreen', 'yellowgreen', 'gold', 'goldenrod', 'orangered', 'firebrick'];
 
jsnx.draw(G, {
    element: '#canvas', 
    weighted: true,
    withLabels: true, 
    labels: 'dns',
    withEdgeLabels: true,
    nodeShape: 'rect',
    edgeLabels: function(d) {
        return d.data[0].ip;
    },
    layoutAttr: {
        charge: -120,
        linkDistance: 350
    },
    nodeAttr: {
        r: 25,
        x: -50,
        y: -10,
        width: 100,
        height: 20,
        title: function(d) { return d.data.dns;}
    },
    nodeStyle: {
        shape: 'square',
        fill: function(d) { 
            if(d.data.timeAgo != null) {
                if(d.data.timeAgo > 7*86400) {
                    return colours[4];
                }else if(d.data.timeAgo > 86400) {
                    return colours[3];
                }else if(d.data.timeAgo > 12*3600) {
                    return colours[2];
                }else if(d.data.timeAgo > 3600) {
                    return colours[1];
                }else if(d.data.timeAgo > 0) {
                    return colours[0];
                }else{
                    return colours[5];
                }
            }else{
                return d.data.color; 
            }
        },
        "stroke-width": 0,
        opacity: 0.8,
    }, 
    labelStyle: {
        fill: '#fff',
    },
    edgeStyle: {
        "stroke-width": (graphType == 'peers' ? 12 : 5),
        fill: function(d) { 
            if(d.source.data.timeAgo != null) {
                return 'darkgrey';
            }else{
                return d.data[0].dns ? 'yellowgreen' : 'tomato'; 
            }
        }
    },
    edgeOffset: function() {
        if(graphType == 'peers')
            return [40, 20];
        return [15,15];
    },
    stickyDrag: true
});
</script>

{% endblock %}